local Player = game.Players.LocalPlayer
local Backpack = Player:WaitForChild("Backpack")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- === Настройки ===
local isSwitching = false
local switchDelay = 0.04
local MAX_DISTANCE = 30 -- Радиус обнаружения (studs)
local UPDATE_INTERVAL = 0.5 -- Обновление FPS каждые 0.5 сек

-- === GUI ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = Player.PlayerGui
ScreenGui.Name = "ItemSwitchMenu"

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 280, 0, 180)
Frame.Position = UDim2.new(0, 10, 0, 10)
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Frame.BackgroundTransparency = 0.1
Frame.BorderSizePixel = 2
Frame.BorderColor3 = Color3.fromRGB(100, 100, 255)
Frame.Parent = ScreenGui

-- Заголовок
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.Text = "Phub FPS Lagger"
Title.TextColor3 = Color3.fromRGB(255, 100, 100)
Title.TextSize = 18
Title.Font = Enum.Font.SourceSansBold
Title.Parent = Frame

-- Кнопка переключения
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1, -20, 0, 40)
ToggleButton.Position = UDim2.new(0, 10, 0, 35)
ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Text = "FPS Lagger: OFF"
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.Parent = Frame

local ToggleIndicator = Instance.new("Frame")
ToggleIndicator.Size = UDim2.new(0, 10, 0, 10)
ToggleIndicator.Position = UDim2.new(0, 5, 0, 5)
ToggleIndicator.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
ToggleIndicator.Parent = ToggleButton

-- Счётчик переключений
local SwitchCountLabel = Instance.new("TextLabel")
SwitchCountLabel.Size = UDim2.new(1, -20, 0, 20)
SwitchCountLabel.Position = UDim2.new(0, 10, 0, 80)
SwitchCountLabel.BackgroundTransparency = 1
SwitchCountLabel.Text = "Switches: 0"
SwitchCountLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
SwitchCountLabel.TextSize = 14
SwitchCountLabel.Parent = Frame

-- === FPS Трекер ===
local FPSTracker = {}
local FPSDisplay = Instance.new("ScrollingFrame")
FPSDisplay.Size = UDim2.new(1, -20, 0, 70)
FPSDisplay.Position = UDim2.new(0, 10, 0, 105)
FPSDisplay.BackgroundTransparency = 1
FPSDisplay.ScrollBarThickness = 4
FPSDisplay.Parent = Frame

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder
UIListLayout.Parent = FPSDisplay

-- === Перетаскивание ===
local isDragging = false
local dragStart, startPos
local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isDragging = true
        dragStart = input.Position
        startPos = Frame.Position
    end
end)

Frame.InputChanged:Connect(function(input)
    if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        TweenService:Create(Frame, tweenInfo, {Position = newPos}):Play()
    end
end)

Frame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isDragging = false
    end
end)

-- === FPS Оценка ===
local function estimateFPS(player)
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end

    local hrp = char.HumanoidRootPart
    local lastPos = hrp.Position
    local lastTime = tick()
    local updates = 0

    -- Считаем обновления позиции за 0.5 сек
    local conn
    conn = RunService.Heartbeat:Connect(function()
        if not player.Character or player.Character.Humanoid.Health <= 0 then
            conn:Disconnect()
            return
        end
        local currPos = hrp.Position
        local currTime = tick()
        if (currPos - lastPos).Magnitude > 0.5 then
            updates += 1
            lastPos = currPos
            lastTime = currTime
        end
    end)

    task.wait(UPDATE_INTERVAL)
    conn:Disconnect()

    local elapsed = tick() - lastTime
    local fps = updates / elapsed
    return math.clamp(math.floor(fps * 2), 1, 200) -- Умножаем на 2 для реалистичности
end

-- === Обновление GUI FPS ===
local function updateFPSDisplay()
    for _, label in pairs(FPSDisplay:GetChildren()) do
        if label:IsA("TextLabel") then label:Destroy() end
    end

    if not Player.Character or not Player.Character:FindFirstChild("HumanoidRootPart") then return end
    local myPos = Player.Character.HumanoidRootPart.Position

    local nearby = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= Player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (plr.Character.HumanoidRootPart.Position - myPos).Magnitude
            if dist <= MAX_DISTANCE then
                table.insert(nearby, {Player = plr, Distance = dist})
            end
        end
    end

    table.sort(nearby, function(a, b) return a.Distance < b.Distance end)

    for i, data in ipairs(nearby) do
        local plr = data.Player
        local fps = estimateFPS(plr) or 0

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 20)
        label.BackgroundTransparency = 1
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Font = Enum.Font.SourceSans
        label.TextSize = 14
        label.LayoutOrder = i

        local status = ""
        local color = Color3.fromRGB(100, 255, 100)
        if fps >= 60 then
            status = "HIGH FPS"
            color = Color3.fromRGB(0, 255, 0)
        elseif fps >= 30 then
            status = "MED FPS"
            color = Color3.fromRGB(255, 255, 0)
        else
            status = "LOW FPS!"
            color = Color3.fromRGB(255, 0, 0)
        end

        label.Text = string.format("%s: ~%d FPS [%s]", plr.DisplayName, fps, status)
        label.TextColor3 = color
        label.Parent = FPSDisplay
    end

    FPSDisplay.CanvasSize = UDim2.new(0, 0, 0, #nearby * 20)
end

-- === Переключение всех инструментов ===
local switchCount = 0
local function switchAllTools()
    local tools = {}
    for _, tool in pairs(Backpack:GetChildren()) do
        if tool:IsA("Tool") then table.insert(tools, tool) end
    end

    if #tools == 0 or not Player.Character then return end
    local hum = Player.Character:FindFirstChild("Humanoid")
    if not hum or hum.Health <= 0 then return end

    for _, tool in ipairs(tools) do
        if not isSwitching then break end
        if hum.Health <= 0 then break end
        if tool.Parent == Backpack then
            hum:EquipTool(tool)
            task.wait(switchDelay)
            hum:UnequipTools()
            task.wait(switchDelay)
            switchCount += 1
            SwitchCountLabel.Text = "Switches: " .. switchCount
        end
    end
end

local function startSwitching()
    while isSwitching do
        if Player.Character and Player.Character:FindFirstChild("Humanoid") and Player.Character.Humanoid.Health > 0 then
            switchAllTools()
        end
        task.wait(0.01)
    end
end

-- === Anti-Lag ===
local function applyAntiLag()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr.Character then
            for _, obj in pairs(plr.Character:GetDescendants()) do
                if obj:IsA("Accessory") or obj:IsA("Shirt") or obj:IsA("Pants") or
                   obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Decal") then
                    obj:Destroy()
                end
            end
        end
    end
end

applyAntiLag()
Players.PlayerAdded:Connect(function(p) p.CharacterAdded:Connect(applyAntiLag) end)

-- === Кнопка ===
ToggleButton.MouseButton1Click:Connect(function()
    isSwitching = not isSwitching
    ToggleIndicator.BackgroundColor3 = isSwitching and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
    ToggleButton.Text = isSwitching and "FPS Lagger: ON" or "FPS Lagger: OFF"
    if isSwitching then spawn(startSwitching) end
end)

-- === Горячая клавиша M ===
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.M then
        Frame.Visible = not Frame.Visible
    end
end)

-- === Обновление FPS каждые 0.7 сек ===
task.spawn(function()
    while true do
        task.wait(0.7)
        if Frame.Visible then
            updateFPSDisplay()
        end
    end
end)
